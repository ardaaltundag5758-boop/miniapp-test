<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stack Ball</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        #game-ui { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        #start-btn { 
            padding: 15px 40px; font-size: 24px; font-weight: bold; background: #fff; border: none; 
            border-radius: 50px; cursor: pointer; pointer-events: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.2); 
        }
        #score-display { position: absolute; top: 50px; font-size: 48px; font-weight: 900; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div id="game-ui">
        <div id="score-display">0</div>
        <button id="start-btn">BAŞLA</button>
    </div>

    <script>
        let scene, camera, renderer, ball, tower, layers = [], fragments = [];
        let isDown = false, gameActive = false, score = 0;
        let ballVel = 0, ballY = 20;
        
        const GRAVITY = 0.01;
        const JUMP_FORCE = 0.18;
        const CRUSH_SPEED = 0.4;
        const LAYER_COUNT = 40;
        const LAYER_GAP = 3.5;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x4facfe);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 30, 35);
            camera.lookAt(0, 10, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            const sun = new THREE.DirectionalLight(0xffffff, 0.5);
            sun.position.set(5, 20, 10);
            scene.add(ambient, sun);

            createLevel();

            document.getElementById('start-btn').addEventListener('click', () => {
                gameActive = true;
                document.getElementById('game-ui').style.display = 'none';
            });

            window.addEventListener('pointerdown', () => { if(gameActive) isDown = true; });
            window.addEventListener('pointerup', () => isDown = false);
            
            animate();
        }

        function createLevel() {
            // Merkezi Kule
            const towerGeo = new THREE.CylinderGeometry(2, 2, 1000, 32);
            const towerMat = new THREE.MeshPhongMaterial({ color: 0xeeeeee });
            tower = new THREE.Mesh(towerGeo, towerMat);
            scene.add(tower);

            // Top
            const ballGeo = new THREE.SphereGeometry(0.8, 32, 32);
            const ballMat = new THREE.MeshPhongMaterial({ color: 0xffffff });
            ball = new THREE.Mesh(ballGeo, ballMat);
            ball.position.set(0, ballY, 3.2);
            scene.add(ball);

            // Kare Bloklar
            for (let i = 0; i < LAYER_COUNT; i++) {
                const isBlack = i > 5 && Math.random() < 0.2 && i < LAYER_COUNT - 2;
                const layer = new THREE.Group();
                layer.position.y = 20 - (i * LAYER_GAP);
                layer.rotation.y = i * 0.2;

                const mat = new THREE.MeshPhongMaterial({ color: isBlack ? 0x222222 : 0x00ff88 });
                
                // 4 Parçalı Kare Yapı
                for(let x=0; x<2; x++) {
                    for(let z=0; z<2; z++) {
                        const piece = new THREE.Mesh(new THREE.BoxGeometry(4.5, 0.8, 4.5), mat);
                        piece.position.set(x === 0 ? -2.3 : 2.3, 0, z === 0 ? -2.3 : 2.3);
                        piece.userData = { fatal: isBlack };
                        layer.add(piece);
                    }
                }
                scene.add(layer);
                layers.push(layer);
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            // Parçalanma Animasyonu
            for (let i = fragments.length - 1; i >= 0; i--) {
                const f = fragments[i];
                f.position.add(f.userData.vel);
                f.userData.vel.y -= 0.02;
                f.rotation.x += 0.1;
                if(f.position.y < -50) {
                    scene.remove(f);
                    fragments.splice(i, 1);
                }
            }

            if (gameActive) {
                if (isDown) {
                    ballVel = -CRUSH_SPEED;
                    checkCollision();
                } else {
                    ballVel += GRAVITY;
                    const layer = layers.find(l => Math.abs(ball.position.y - (l.position.y + 1)) < 0.4);
                    if (layer && ballVel > 0) {
                        ballVel = -JUMP_FORCE;
                    }
                }

                ballY -= ballVel;
                ball.position.y = ballY;

                // Kamera Sabit Takip
                camera.position.y = ball.position.y + 15;
                camera.lookAt(0, ball.position.y - 5, 0);
            }

            renderer.render(scene, camera);
        }

        function checkCollision() {
            const layerIdx = layers.findIndex(l => Math.abs(ball.position.y - l.position.y) < 1.0);
            if (layerIdx !== -1) {
                const layer = layers[layerIdx];
                if (layer.children[0].userData.fatal) {
                    location.reload(); // Kaybetme
                    return;
                }
                explodeLayer(layer);
                layers.splice(layerIdx, 1);
                score += 10;
                document.getElementById('score-display').innerText = score;
            }
        }

        function explodeLayer(layer) {
            while(layer.children.length > 0) {
                const p = layer.children[0];
                const worldPos = new THREE.Vector3();
                p.getWorldPosition(worldPos);
                scene.remove(p);
                p.position.copy(worldPos);
                p.userData.vel = new THREE.Vector3(p.position.x * 0.2, 0.1, p.position.z * 0.2);
                scene.add(p);
                fragments.push(p);
            }
            scene.remove(layer);
        }

        init();
    </script>
</body>
</html>
